<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <script src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
    <style>
        body,
        html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            background: #ffffff;
            overflow: hidden;
            font-family: "Microsoft YaHei", sans-serif;
        }

        #network-container {
            width: 100%;
            /* é¢„ç•™ 80px ç»™ headerï¼Œä¿è¯ä¸å’Œå›¾è°±é‡å  */
            height: calc(100vh - 80px);
            position: relative;
        }

        .header {
            width: 100%;
            height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            color: #000000;
            font-size: 32px;
            font-weight: bold;
            background-color: #fff;
            z-index: 10;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            /* ä¿è¯æ ‡é¢˜åœ¨æœ€ä¸Šå±‚ */
            position: relative;
        }
    </style>
</head>

<body>
    <div class="header">ğŸŒ¸ ç¾¤ {{ group_name }} ä»Šæ—¥è€å©†ç¾ç»Šå›¾è°± ğŸŒ¸</div>
    <div id="network-container"></div>

    <script>
        const raw_data = {{ records | tojson }};
        const user_map = {{ user_map | tojson }} || {};
        const nodes = [];
        const edges = [];
        const userSet = new Set();

        raw_data.forEach(r => {
            const userName = user_map[r.user_id] || "ç”¨æˆ·" + r.user_id;
            const wifeName = user_map[r.wife_id] || r.wife_name;

            [{ id: r.user_id, name: userName }, { id: r.wife_id, name: wifeName }].forEach(u => {
                if (!userSet.has(u.id)) {
                    userSet.add(u.id);
                    nodes.push({
                        id: u.id,
                        label: u.name,
                        shape: 'circularImage',
                        image: `https://q4.qlogo.cn/headimg_dl?dst_uin=${u.id}&spec=640`,
                        borderWidth: 6,
                        size: 50, // å¢å¤§å¤´åƒå°ºå¯¸ï¼Œæ›´æ¸…æ™°
                        color: { border: '#4facfe', background: '#ffffff' },
                        font: {
                            color: '#000000',
                            size: 18,
                            vadjust: 55, // åå­—å‘ä¸‹åç§»ï¼Œä¸æŒ¡å¤´åƒ
                            strokeWidth: 5, // å¼ºæè¾¹
                            strokeColor: '#ffffff',
                            bold: { color: '#000000', size: 18, vadjust: 55 }
                        }
                    });
                }
            });

            edges.push({
                from: r.user_id,
                to: r.wife_id,
                label: r.forced ? "å¼ºå¨¶" : "æŠ½ä¸­",
                arrows: 'to',
                color: { color: r.forced ? '#ff4d4f' : '#1890ff', width: 4 },
                font: { align: 'middle', color: '#444', size: 16, background: '#ffffff' },
                length: 300 // æ‹‰å¼€èŠ‚ç‚¹é—´è·ï¼Œé˜²æ­¢åå­—é‡å 
            });
        });

        const container = document.getElementById('network-container');
        const data = { nodes: new vis.DataSet(nodes), edges: new vis.DataSet(edges) };
        const options = {
            nodes: {
                shape: 'circularImage',
                font: { face: 'Microsoft YaHei' }
            },
            edges: {
                smooth: {
                    type: 'curvedCW',
                    roundness: 0.2
                }
            },
            physics: {
                enabled: true,
                barnesHut: {
                    gravitationalConstant: -10000,
                    centralGravity: 0.1,
                    springLength: 300,
                    avoidOverlap: 2
                },
                stabilization: {
                    enabled: true,
                    iterations: 200,
                    updateInterval: 25,
                    onlyDynamicEdges: false,
                    fit: true
                }
            }
        };
        const network = new vis.Network(container, data, options);
        network.once("stabilizationIterationsDone", function () {
            network.fit();
        });
    </script>
</body>

</html>